# Новый подход к оптимизации размера файлов

## Проблема
Предыдущий подход с расширением кадров обратно до оригинального размера при экспорте приводил к большим файлам, так как терялись преимущества сжатия.

## Новое решение

### Ключевые принципы:

1. **Сжатие при захвате** - кадры сжимаются сразу после захвата и хранятся как JPEG
2. **Использование сжатых размеров** - при экспорте GIF используются уже уменьшенные размеры, без расширения обратно
3. **Многоуровневая оптимизация** - несколько этапов сжатия для максимального уменьшения размера

### Архитектура оптимизации:

```
Захват кадра (pixelRatio: 0.3)
    ↓
PNG конвертация
    ↓
Ресайз до 40% (resizeRatio: 0.4)
    ↓
JPEG сжатие (quality: 65)
    ↓
Хранение в памяти (очень компактно)
    ↓
При экспорте: используем сжатые размеры напрямую
    ↓
GIF квантовка (128 цветов)
    ↓
Финальный GIF файл (минимальный размер)
```

## Параметры оптимизации

### 1. pixelRatio (разрешение захвата)
- **По умолчанию**: 0.3
- **Диапазон**: 0.2 - 1.0
- **Влияние**: Определяет разрешение при захвате кадра
- **Рекомендация**: 0.3 для минимального размера

### 2. resizeRatio (коэффициент ресайза)
- **По умолчанию**: 0.4 (40% от оригинала)
- **Диапазон**: 0.3 - 1.0
- **Влияние**: Уменьшает размер изображения перед JPEG сжатием
- **Рекомендация**: 0.4 для максимального сжатия, 0.5-0.6 для баланса

### 3. jpegQuality (качество JPEG)
- **По умолчанию**: 65
- **Диапазон**: 1 - 100
- **Влияние**: Качество JPEG сжатия при хранении
- **Рекомендация**: 65 для минимального размера, 75 для баланса

### 4. maxGifWidth / maxGifHeight (ограничение размера GIF)
- **По умолчанию**: 400x800 (опционально)
- **Влияние**: Дополнительное ограничение максимального размера GIF
- **Рекомендация**: Установите для очень больших экранов

### 5. skipFramesBetweenCaptures (пропуск кадров)
- **По умолчанию**: 2
- **Влияние**: Количество пропускаемых кадров между захватами
- **Рекомендация**: 2-3 для баланса, 4-5 для очень длинных записей

## Ключевые улучшения

### 1. Использование сжатых размеров при экспорте
**До**: Кадры расширялись обратно до оригинального размера при экспорте
```dart
// Старый подход - расширяли обратно
finalImage = image.copyExpandCanvas(
  decodedImage,
  newWidth: compressedFrame.originalWidth,  // ❌ Использовали оригинал
  newHeight: compressedFrame.originalHeight,
);
```

**После**: Используем уже сжатые размеры
```dart
// Новый подход - используем сжатый размер
image.Image finalImage = decodedImage;  // ✅ Используем сжатый размер
```

### 2. Агрессивная квантовка GIF
- Уменьшено количество цветов в палитре до 128 (вместо 256)
- Это значительно уменьшает размер GIF файла

### 3. Ограничение максимального размера
- Добавлена возможность ограничить максимальный размер GIF
- Полезно для очень больших экранов

## Примеры использования

### Минимальный размер (максимальная оптимизация)
```dart
ScreenRecorderController(
  pixelRatio: 0.3,
  resizeRatio: 0.35,
  jpegQuality: 60,
  maxGifWidth: 400,
  maxGifHeight: 800,
  skipFramesBetweenCaptures: 3,
)
```
**Ожидаемое уменьшение**: ~80-90% от исходного размера

### Сбалансированный (по умолчанию)
```dart
ScreenRecorderController(
  pixelRatio: 0.3,
  resizeRatio: 0.4,
  jpegQuality: 65,
  skipFramesBetweenCaptures: 2,
)
```
**Ожидаемое уменьшение**: ~70-80% от исходного размера

### Хорошее качество
```dart
ScreenRecorderController(
  pixelRatio: 0.4,
  resizeRatio: 0.5,
  jpegQuality: 75,
  skipFramesBetweenCaptures: 2,
)
```
**Ожидаемое уменьшение**: ~50-60% от исходного размера

## Преимущества нового подхода

1. **Экономия памяти**: Кадры хранятся как сжатые JPEG, а не полные PNG
2. **Меньший размер файла**: Используем сжатые размеры напрямую, без расширения
3. **Быстрее экспорт**: Меньше данных для обработки
4. **Гибкость**: Все параметры настраиваемы

## Технические детали

### Процесс сжатия кадра:
1. `ui.Image` → PNG байты
2. Декодирование PNG
3. Ресайз до целевого размера (с учетом maxGifWidth/Height)
4. JPEG сжатие
5. Хранение как `CompressedFrame` (только JPEG байты + метаданные)

### Процесс экспорта:
1. Декодирование JPEG кадров
2. Использование сжатых размеров (без расширения)
3. Квантовка до 128 цветов
4. Кодирование в GIF

## Сравнение с предыдущим подходом

| Параметр | Старый подход | Новый подход |
|----------|---------------|--------------|
| resizeRatio | 0.7 (70%) | 0.4 (40%) |
| jpegQuality | 88 | 65 |
| Расширение при экспорте | Да (до оригинала) | Нет (используем сжатый) |
| Квантовка GIF | 256 цветов | 128 цветов |
| Ожидаемое уменьшение | ~50% | ~70-80% |

## Рекомендации

1. **Для записи текста**: Используйте `jpegQuality: 75+` и `resizeRatio: 0.5+`
2. **Для UI/анимаций**: Можно использовать более агрессивные настройки
3. **Для длинных записей**: Увеличьте `skipFramesBetweenCaptures` до 3-5
4. **Для больших экранов**: Установите `maxGifWidth` и `maxGifHeight`

## Тестирование

Рекомендуется протестировать с разными настройками и выбрать оптимальный баланс для вашего случая использования. Начните с значений по умолчанию и корректируйте при необходимости.
