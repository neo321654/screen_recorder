# Бинарный формат Raw RGBA

## Обзор

Проект переведен на новый бинарный формат raw RGBA вместо GIF. Это позволяет:
- Сохранять кадры в сыром формате без потери качества
- Легко декодировать на любой платформе
- Отправлять данные на backend без промежуточных форматов
- Контролировать размеры изображений как в предыдущей реализации

## Формат бинарника

### Заголовок (18 байт)

```
Offset | Размер | Тип      | Описание
-------|--------|----------|------------------
0x00   | 4      | bytes    | Magic number: "RGBA"
0x04   | 1      | uint8    | Версия формата: 1
0x05   | 4      | uint32   | Количество кадров (little-endian)
0x09   | 4      | uint32   | Максимальная ширина (little-endian)
0x0D   | 4      | uint32   | Максимальная высота (little-endian)
0x11   | 1      | uint8    | Grayscale флаг: 0 или 1
```

### Кадры

Для каждого кадра:

```
Offset | Размер | Тип      | Описание
-------|--------|----------|------------------
+0     | 8      | int64    | Timestamp в миллисекундах (little-endian)
+8     | 4      | uint32   | Ширина кадра (little-endian)
+12    | 4      | uint32   | Высота кадра (little-endian)
+16    | N      | bytes    | Пиксельные данные (width * height * 4 байт)
```

### Формат пиксельных данных

Каждый пиксель = 4 байта в формате RGBA:
- Байт 0: Red (0-255)
- Байт 1: Green (0-255)
- Байт 2: Blue (0-255)
- Байт 3: Alpha (0-255)

Порядок: строка за строкой, слева направо, сверху вниз.

## Использование

### В Flutter

```dart
// Создание контроллера с настройками размеров
final controller = ScreenRecorderController(
  resizeRatio: 0.3,      // Масштабирование
  maxGifWidth: 360,      // Максимальная ширина
  maxGifHeight: 640,     // Максимальная высота
  grayscale: false,      // Grayscale режим
);

// Запись...
controller.start();
// ... запись кадров ...
controller.stop();

// Экспорт в бинарный формат
final binaryData = await controller.exporter.exportGif();
if (binaryData != null) {
  // Сохранение или отправка на backend
  await file.writeAsBytes(binaryData);
}
```

### Декодирование на Mac

```bash
# Установка зависимостей (один раз, обязательно!)
pip3 install Pillow numpy

# Декодирование бинарника
python3 decode_binary_rgba.py recording.bin

# С указанием директории для сохранения
python3 decode_binary_rgba.py recording.bin output_frames/

# Из stdin
cat recording.bin | python3 decode_binary_rgba.py - output_frames/
```

**Важно:** Если вы видите ошибку `ModuleNotFoundError: No module named 'PIL'`, 
установите зависимости командой `pip3 install Pillow numpy`

Скрипт создаст:
- PNG файлы для каждого кадра: `frame_00001_t1234ms.png`
- Файл с информацией: `info.txt`

## Настройки размеров

Как и в предыдущей реализации, применяются следующие настройки:

1. **resizeRatio** (по умолчанию: 0.3)
   - Масштабирует изображение перед сохранением
   - Меньше значение = меньше размер файла

2. **maxGifWidth** (по умолчанию: 360)
   - Максимальная ширина кадра
   - Если кадр больше, масштабируется пропорционально

3. **maxGifHeight** (по умолчанию: 640)
   - Максимальная высота кадра
   - Если кадр больше, масштабируется пропорционально

4. **grayscale** (по умолчанию: false)
   - Конвертирует изображение в оттенки серого
   - Уменьшает размер данных

## Пример размера файла

Для записи 10 секунд при 10 FPS (100 кадров):

- **Без оптимизации**: 1080x1920, 100 кадров = ~829 MB
- **С resizeRatio 0.3**: 324x576, 100 кадров = ~74 MB
- **С maxWidth 360, maxHeight 640**: 360x640, 100 кадров = ~92 MB
- **С grayscale**: дополнительно уменьшает размер на ~25%

## Логирование

Все операции логируются с префиксами:
- `[RawRgbaExporter]` - обработка кадров
- `[ScreenRecorderWrapper]` - сохранение файла
- `[Decoder]` - декодирование (Python скрипт)

## Миграция с GIF формата

Старый код продолжит работать, но теперь:
- `exportGif()` возвращает бинарный формат raw RGBA вместо GIF
- Файлы сохраняются с расширением `.bin` вместо `.gif`
- Для декодирования используйте `decode_binary_rgba.py` вместо просмотра GIF

## Преимущества нового формата

1. ✅ **Без потери качества** - сырые RGBA данные
2. ✅ **Простое декодирование** - любой язык программирования
3. ✅ **Гибкость** - можно применять любую обработку на backend
4. ✅ **Меньше зависимостей** - не нужны библиотеки для GIF
5. ✅ **Метаданные** - timestamp для каждого кадра
6. ✅ **Совместимость** - те же настройки размеров
