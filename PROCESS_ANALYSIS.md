# Анализ процесса захвата и сохранения скриншотов

## Текущий процесс (пошагово)

### 1. Захват кадра
```
toImageSync(pixelRatio: 0.25)
  ↓
ui.Image (RGBA, несжатое в памяти)
  ↓
Размер: width × height × 4 байта
Пример: 1080×1920 × 0.25 = 270×480 × 4 = ~518 KB на кадр
```

### 2. Конвертация в байты
```
toByteData(format: rawRgba)
  ↓
ByteData (raw RGBA байты)
  ↓
Те же ~518 KB
```

### 3. Создание image.Image
```
Image.fromBytes(width, height, bytes, numChannels: 4)
  ↓
image.Image (RGBA)
  ↓
Те же ~518 KB в памяти
```

### 4. Ресайз
```
copyResize(interpolation: Interpolation.average)
  ↓
image.Image (уменьшенное)
  ↓
Пример: 270×480 → 81×144 (при resizeRatio: 0.3)
Размер: ~46 KB
```

### 5. Grayscale (опционально)
```
grayscale() - если включено
  ↓
image.Image (оттенки серого)
  ↓
Размер не меняется, но палитра упрощается
```

### 6. Квантовка цветов
```
quantize(numberOfColors: 32 или 128)
  ↓
image.Image (индексированные цвета)
  ↓
Размер в памяти не меняется, но палитра уменьшена
```

### 7. Хранение в памяти
```
_frames.add(CompressedFrame(timestamp, processed))
  ↓
Список image.Image в памяти
  ↓
~46 KB × количество кадров
```

### 8. Экспорт GIF
```
encodeGif(gif) - без оптимизированных параметров
  ↓
Uint8List (GIF байты)
  ↓
Финальный размер файла
```

## Проблемы и возможности оптимизации

### Проблема 1: Неоптимальные параметры encodeGif
**Текущее**: `encodeGif(gif)` без параметров
**Проблема**: Используются дефолтные значения, которые не оптимизированы для размера

**Решение**: Использовать оптимизированные параметры:
- `samplingFactor: 30` - более агрессивная квантовка
- `dither: DitherKernel.none` - отключение dithering для меньшего размера

**Эффект**: Уменьшение размера на 10-20% без потери визуального качества

### Проблема 2: Неоптимизированная прозрачность
**Текущее**: Полупрозрачные пиксели сохраняются как есть
**Проблема**: GIF поддерживает только бинарную прозрачность, но код сохраняет полупрозрачность

**Решение**: Бинаризация альфа-канала перед квантовкой
- Альфа < 128 → полностью прозрачный
- Альфа >= 128 → полностью непрозрачный

**Эффект**: Уменьшение размера на 5-15% за счет более эффективной палитры

### Проблема 3: Метод квантовки
**Текущее**: `quantize()` с дефолтным методом
**Проблема**: Не самый эффективный метод для размера

**Решение**: Использовать `QuantizeMethod.neuralNet` или `QuantizeMethod.octree`
**Эффект**: Лучшая палитра при том же количестве цветов

### Проблема 4: Interpolation.average
**Текущее**: `Interpolation.average` для ресайза
**Проблема**: Может создавать артефакты, но это не влияет на размер

**Решение**: Оставить как есть (не влияет на размер файла)

## Оптимизации для минимального размера без потери качества

### Оптимизация 1: Параметры encodeGif
```dart
encodeGif(
  gif,
  samplingFactor: 30,  // Более агрессивная квантовка
  dither: DitherKernel.none,  // Отключение dithering
  ditherSerpentine: false,
)
```

### Оптимизация 2: Бинаризация прозрачности
```dart
// Перед квантовкой
processed = _binarizeAlpha(processed);
```

### Оптимизация 3: Оптимизированный метод квантовки
```dart
quantize(
  processed,
  numberOfColors: grayscale ? 32 : 128,
  method: QuantizeMethod.neuralNet,  // Лучший метод
)
```

## Ожидаемый эффект

| Оптимизация | Уменьшение размера | Влияние на качество |
|-------------|-------------------|---------------------|
| Параметры encodeGif | 10-20% | Минимальное |
| Бинаризация прозрачности | 5-15% | Минимальное |
| Метод квантовки | 3-8% | Нет (лучше палитра) |
| **Итого** | **15-40%** | **Минимальное** |
